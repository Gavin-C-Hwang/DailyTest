<!DOCTYPE html>
<html>
<title>Daily Test</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Oswald">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open Sans">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        font-family: "Oswald"
    }

    body {
        font-family: "Open Sans"
    }

    .word-btn {
        background-color: rgb(240, 240, 240);
        padding: 8px;
    }

    .w3-animate-zoomout {
    animation: animatezoomout 0.6s
}

@keyframes animatezoomout {
    from {
        transform: scale(1)
    }

    to {
        transform: scale(0)
    }
}
    
</style>

<body class="w3-light-grey">

    <div class="w3-content" style="max-width:1600px">

        <!-- Header -->
        <header class="w3-container w3-center w3-white">
            <h1 class="w3-xxxlarge"><b><span name="lbDailyTest">Daily Test</span></b></h1>
            <h3 id="totScore"></h3>
            <h5 class="w3-opacity" id="date">JAN 8, 2019</h5>
        </header>

        <!-- Grid -->
        <div class="w3-row w3-border">

            <!-- Blog entry -->
            <div class="w3-container w3-white w3-margin">
                <div class="w3-center">
                    <h3><span name="lbWord">Word</span><span id="wordScore" style="margin-left: 10px;"></span></h3>
                </div>

                <div class="w3-justify">
                    <table id='tbVoca' style="width: 100%; border-spacing: 8px;">
                    </table>
                    <div id="divWordsExam" style="text-align: center; margin: 20px;">
                    </div>
                </div>
            </div>
            <hr>

            <div class="w3-container w3-white w3-margin">
                <div class="w3-center">
                    <h3><span name="lbSentence">Sentence</span><span id="sentenceScore" style="margin-left: 10px;"></span></h3>
                </div>
                <div id="divSentences">
                </div>
            </div>
            <hr>
            <!-- END BLOG ENTRIES -->
            <div class="w3-center">
                <a href="#" class="w3-button w3-red w3-padding-large w3-margin-bottom" onclick="getScore()" id="submit"><span name="lbSubmit">Submit</span></a>
            </div>
        </div>
        <!-- END GRID -->
        <!-- END w3-content -->


    </div>


    <!-- Footer -->
    <footer class="w3-container w3-dark-grey w3-center" style="padding:32px">
        <a href="#" onclick="document.getElementById('registerQuizForm').style.display='block'" class="w3-button w3-black w3-padding-large w3-margin-bottom"><span name="lbRegQuiz">New Quiz</span></a>
        <a href="#" onclick="" class="w3-button w3-black w3-padding-large w3-margin-bottom"><span name="lbHistory">History</span></a>
    </footer>
    <div id="registerQuizForm" class="w3-modal">
        <div class="w3-modal-content w3-animate-zoom">
            <div class="w3-container w3-black">
                <span onclick="document.getElementById('registerQuizForm').style.display='none'" class="w3-button w3-display-topright w3-large">x</span>
                <h3><span name="lbRegQuiz">New Quiz</span></h3>
            </div>
            <div class="w3-container">
                <p><span name="lbWord">Word</span></p>
                <p class="qf-word"><input class="w3-input w3-padding-16 w3-border" type="text" style="width: 45%; display: inline"  placeholder="lbSourceLang" onkeypress="newQuiz.onKeyPressFirst()">
                <input class="w3-input w3-padding-16 w3-border" type="text" style="width: 45%; display: inline" placeholder="lbTargetLang" onkeypress="newQuiz.onKeyPressSecond()"></p>
                <p><span name="lbSentence">Sentence</span></p>
                <p class="qf-sentence"><input class="w3-input w3-padding-16 w3-border" type="text" placeholder="lbTargetLang" onkeypress="newQuiz.onKeyPressSentence()">
                </p>
                <p class="w3-center"><button class="w3-button w3-dark-grey" onclick="newQuiz.register();"><span name="lbComplete">Complete</span></button></p>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script>
        /*let lang = {
            lbDailyTest : "Daily Test"
            ,lbWord : "Word"
            ,lbSourceLang : "English"
            ,lbTargetLang : "Korean"
            ,lbSentence : "Sentence"
            ,lbSubmit : "Submit"
            ,lbRegQuiz : "New Quiz"
            ,lbHistory : "History"
            ,lbComplete : "Complete"
            ,lbResult : "Result"
            ,lbScore : "Score"
            ,msgSolveAll : "Please Solve all quizz."
        }*/
        let lang = {
            lbDailyTest : "매일 쪽지시험"
            ,lbWord : "단어"
            ,lbSourceLang : "영어"
            ,lbTargetLang : "한국어"
            ,lbSentence : "문장"
            ,lbSubmit : "제출"
            ,lbRegQuiz : "새 문제"
            ,lbHistory : "내역 보기"
            ,lbComplete : "완료"
            ,lbResult : "결과"
            ,lbScore : "점"
            ,msgSolveAll : "모든 문제를 다 풀어주세요."
        }
        let words = new Array();
        let sentences = new Array();
        let quizId = "";

        window.onload = function() {
            
            let date = new Date();
            document.querySelector('#date').innerHTML = date.getFullYear()+"."+(date.getMonth()+1)+"."+date.getDate();
            multiLang();
            retrieveWords();
        }
        
        window.addEventListener('scroll', setDivWordsExamLoc);
        
        function multiLang(){
            for(let key in lang){
                document.getElementsByName(key).forEach(function(obj){
                    obj.innerHTML = lang[key];
                });
                document.querySelectorAll("input[placeholder="+key+"]").forEach(function(obj){
                    obj.setAttribute("placeholder",lang[key]);
                });
            }
        }
        function afterLoad(){
            words = mixWords(words);
            sentences = mixSentences(sentences);
            initVoca(words);
            initSentence(sentences);
        }
        
        function initVoca(words) {
            
            words.forEach(function(item) {
                let tbVoca = document.querySelector('#tbVoca');
                let tr = document.createElement('tr');
                tr.style.height = '40px';
                tr.classList.add('w3-animate-zoom');
                tr.innerHTML = '<td style="width: 40%; text-align: right; padding-right: 10px">' + item[0] + '</td>' +
                    '<td><div style="height: 50%;border-bottom: 1px solid gray"></div></td>' +
                    '<td style="width: 40%;padding-left: 10px"><span class="words" style="color : rgb(0,0,0)">__________</span></td>';
                tbVoca.appendChild(tr);
                setTimeout(function(){
                    addWordsExam(item[1]);
                    tr.classList.remove('w3-animate-zoom');
                },1000);
            });

            setDivWordsExamLoc();
            
        }

        function setDivWordsExamLoc(){
            let scrollLoc = 220 + document.querySelector('#tbVoca').offsetHeight + document.querySelector('#divWordsExam').offsetHeight -window.innerHeight;
            if(window.scrollY > scrollLoc){
                let divWordsExam = document.querySelector('#divWordsExam');
                divWordsExam.style.position = 'static';
                divWordsExam.style.backgroundColor = '#ffffff';
                divWordsExam.style.removeProperty('left');
                divWordsExam.style.removeProperty('bottom');
                divWordsExam.style.removeProperty('margin');
                divWordsExam.style.removeProperty('padding');
            }else{
                let divWordsExam = document.querySelector('#divWordsExam');
                divWordsExam.style.position = 'fixed';
                divWordsExam.style.padding = (divWordsExam.innerHTML.trim()==''?'0px':'16px');
                divWordsExam.style.bottom = '0px';
                divWordsExam.style.left = '0px';
                divWordsExam.style.backgroundColor = '#ffffff';
            }
        }
        
        function initSentence(sentences){
            let divSentences = document.querySelector('#divSentences');
            sentences.forEach(function(item){
                let phs = item.split(' ');
                let divBlankSt = document.createElement('div');
                let divBtnPhs = document.createElement('div');
                divBlankSt.classList.add('w3-justify');
                divBlankSt.classList.add('w3-center');
                divBlankSt.style.marginTop = '40px';
                phs.forEach(function(item){
                    let span = document.createElement('span');
                    span.innerHTML = getBlank(item);
                    divBlankSt.appendChild(span);
                    divBlankSt.innerHTML = divBlankSt.innerHTML+'&nbsp;&nbsp;';
                });
                divSentences.appendChild(divBlankSt);
                divBtnPhs.classList.add('eval-valid');
                divBtnPhs.style.textAlign = 'center';
                divBtnPhs.style.margin = '20px';
                phs.forEach(function(item){
                    addSentenceExam(item,divBtnPhs);
                });
                divSentences.appendChild(divBtnPhs);
                divSentences.appendChild(document.createElement('hr'));
            });
        }
        
        function getBlank(item){
            let result = '';
            for(let i = 0; i<item.length; i++){
                result += '__';
            }
            return result;
        }

        function addWordsExam(text) {
            var obj = document.createElement('span');
            obj.classList.add('w3-button');
            obj.classList.add('word-btn');
            obj.classList.add('w3-animate-zoom');
            obj.style.margin = '5px';
            obj.addEventListener('click', onClickWord);
            obj.innerHTML = text;
            var divWordsExam = document.querySelector('#divWordsExam');
            divWordsExam.classList.add('eval-valid');
            let ran = Math.floor(Math.random()*100);
            let ranIdx = ran%divWordsExam.children.length;
            divWordsExam.insertBefore(obj,divWordsExam.children[ranIdx]);
            setTimeout(function(){obj.classList.remove('w3-animate-zoom')},150);
        }
        
        function addSentenceExam(text,parent){
            let span = document.createElement('span');
            span.classList.add('w3-button');
            span.classList.add('word-btn');
            span.classList.add('w3-animate-zoom');
            span.style.margin = '5px';
            span.innerHTML = text;
            span.addEventListener('click', onClickSentence);
            
            let ran = Math.floor(Math.random()*100);
            let ranIdx = ran%parent.children.length;
            parent.insertBefore(span,parent.children[ranIdx]);
            setTimeout(function(){span.classList.remove('w3-animate-zoom')},150);
        }

        function onClickWord() {
            var blank = document.getElementsByClassName('words');
            for (let item of blank) {
                if (item.innerHTML === '__________') {
                    let oldItem = this;
                    item.innerHTML = oldItem.innerHTML;
                    item.classList.add('w3-button');
                    item.classList.add('word-btn');
                    item.classList.add('w3-animate-zoom');
                    item.style.color = oldItem.style.color;
                    item.addEventListener('click', onClickWordCancel);
                   
                    oldItem.classList.add('w3-animate-zoomout');
                    setTimeout(function(){
                        oldItem.classList.remove('w3-animate-zoomout');
                        oldItem.parentElement.removeChild(oldItem);
                    },150);
                    
                    setTimeout(function(){item.classList.remove('w3-animate-zoom')},150);
                    break;
                }

            }
        }

        function onClickWordCancel() {
            let oldItem = this;
            let text = oldItem.innerHTML;
            oldItem.classList.add('w3-animate-zoomout');
            setTimeout(function(){
                oldItem.innerHTML = '__________';
                oldItem.classList.remove('w3-button');
                oldItem.classList.remove('word-btn');
                oldItem.removeEventListener('click',onClickWordCancel);
                oldItem.classList.remove('w3-animate-zoomout');
            },150);
            addWordsExam(text);

        }
        
        function onClickSentence(){
            const pattern = /^_+$/;
            let divBlankSentence = this.parentElement.previousSibling;
            let spans = divBlankSentence.querySelectorAll('span');
            
            for(let span of spans){
                if( pattern.test(span.innerHTML) ){
                    let oldItem = this;
                    span.setAttribute('oritext',span.innerHTML);
                    span.innerHTML = oldItem.innerHTML;
                    span.classList.add('w3-button');
                    span.classList.add('word-btn');
                    span.classList.add('w3-animate-zoom');
                    span.style.margin = '5px';
                    span.addEventListener('click',onClickSentenceCancel);
                    
                    oldItem.classList.add('w3-animate-zoomout');
                    setTimeout(function(){
                        oldItem.classList.remove('w3-animate-zoomout');
                        oldItem.parentElement.removeChild(oldItem);
                    },150);
                    
                    setTimeout(function(){span.classList.remove('w3-animate-zoom')},150);
                    break;
                }
            }
        }
        
        function onClickSentenceCancel(){
            let oldItem = this;
            let oriText = oldItem.getAttribute('oritext');
            let text = oldItem.innerHTML;
            oldItem.classList.add('w3-animate-zoomout');
            setTimeout(function(){
                oldItem.innerHTML = oriText;
                oldItem.classList.remove('w3-button');
                oldItem.classList.remove('word-btn');
                oldItem.removeEventListener('click',onClickSentenceCancel);
                oldItem.classList.remove('w3-animate-zoomout');
            },150);
            addSentenceExam(text,oldItem.parentElement.nextElementSibling);
        }
        
        function mixWords(words){
            let result = new Array();
            let i = 0;
            while(words.length > 0){
                let ran = Math.floor(Math.random()*100);
                let ranIdx = ran%words.length;
                result[i++] = words[ranIdx];
                words.splice(ranIdx,1);
            }
            return result;
        }
        
        function mixSentences(sentences){
            let result = new Array();
            let i = 0;
            while(sentences.length > 0){
                let ran = Math.floor(Math.random()*100);
                let ranIdx = ran%sentences.length;
                result[i++] = sentences[ranIdx];
                sentences.splice(ranIdx,1);
            }
            return result;
        }
        
        function getScore(){
            var evalValids = document.querySelectorAll('.eval-valid');
            for(let i = 0; i<evalValids.length; i++){
                if(evalValids[i].innerHTML.trim() !== ''){
                  alert(lang.msgSolveAll);
                return;  
                }
            }
            
            let wordScore = wordsEvaluate();
            let sentenceScore = sentencesEvaluate();
            let totScore = document.querySelector('#totScore');
            let totCnt = wordScore[0] + sentenceScore[0];
            let rightCnt = wordScore[1] + sentenceScore[1];
            let score = Math.floor( (rightCnt/totCnt)*100 );
            totScore.innerHTML = lang.lbResult+" : "+score+lang.lbScore;
            document.querySelector('#submit').style.display = 'none';
            let evalResult = "t:"+score+","+Math.floor( (wordScore[1]/wordScore[0])*100 )+","+Math.floor( (sentenceScore[1]/sentenceScore[0])*100 )
                            +"\nw:"+wordScore[2]+"\ns:"+sentenceScore[2];
            sendResult(evalResult);
        }
        
        function wordsEvaluate(){
            let wrongAnswer = "";
            let tbVoca = document.querySelector('#tbVoca');
            let trs = tbVoca.querySelectorAll('tr');
            let totCnt = trs.length;
            let rightCnt = 0;
            trs.forEach(function(item,index){
                let tds = item.querySelectorAll('td');
                let isCorrect = false;
                item.style.outline = '2px solid #ff9f9f';
                for(let i = 0; i<words.length; i++){
                    if(words[i][0] === tds[0].innerHTML
                      && words[i][1] === tds[2].querySelector('span').innerHTML ){
                        item.style.outline = '2px solid #3ca73c';
                        isCorrect = true;
                        rightCnt++;
                        break;
                    }
                }
                if(!isCorrect){
                    let rightAns = document.createElement('span');
                    rightAns.style.color = 'green';
                    rightAns.style.fontWeight = 'bold';
                    rightAns.style.marginLeft = '10px';
                    rightAns.innerHTML = words[index][1];
                    tds[2].appendChild(rightAns);
                    wrongAnswer  = wrongAnswer + "@next@"+words[index][0]+","+words[index][1];
                }
                tds[2].querySelector('span').classList.remove('w3-button');
                tds[2].querySelector('span').classList.remove('word-btn');
                tds[2].querySelector('span').removeEventListener('click',onClickWordCancel);
                let wordScore = document.querySelector('#wordScore');
                let score = Math.floor( (rightCnt/totCnt)*100 );
                wordScore.style.color = (score>80?'green':'red');
                wordScore.innerHTML = getEvalMsg(score);
            });
            return [totCnt,rightCnt,wrongAnswer.substring(6)];
        }
        
        function sentencesEvaluate(){
            let wrongAnswer = "";
            let divSentences = document.querySelector('#divSentences');
            let divs = divSentences.querySelectorAll('div');
            let totCnt = divs.length/2;
            let rightCnt = 0;
            for(let idxDiv = 0; idxDiv < divs.length; idxDiv+=2){
                let item = divs[idxDiv];
                let isCorrect = false;
                let spans = item.querySelectorAll('span');
                let spanText = "";
                item.style.border = '2px solid #ff9f9f';
                item.style.padding = '8px';
                for(let i = 0; i<spans.length; i++){
                    spanText = spanText + " " + spans[i].innerHTML;
                    spans[i].classList.remove('w3-button');
                    spans[i].classList.remove('word-btn');
                    spans[i].style.margin = '0px';
                    spans[i].removeEventListener('click',onClickSentenceCancel);
                }
                for(let i = 0; i<sentences.length; i++){
                    if(spanText.substring(1) == sentences[i]){
                        item.style.border = '2px solid #3ca73c';
                        isCorrect = true;
                        rightCnt++;
                        break;
                    }
                }
                if(!isCorrect){
                    let rightAns = document.createElement('div');
                    rightAns.style.color = 'green';
                    rightAns.style.fontWeight = 'bold';
                    rightAns.style.marginLeft = '10px';
                    rightAns.innerHTML = sentences[idxDiv/2];
                    item.appendChild(rightAns);
                    wrongAnswer  = wrongAnswer + "@next@"+sentences[idxDiv/2];
                }
                let sentenceScore = document.querySelector('#sentenceScore');
                let score = Math.floor( (rightCnt/totCnt)*100 );
                sentenceScore.style.color = (score>80?'green':'red');
                sentenceScore.innerHTML = getEvalMsg(score);
            }
            return [totCnt,rightCnt,wrongAnswer.substring(6)];
        }
        
        function getEvalMsg(score){
            if(score == 100) return 'Perfect!';
            else if(score >90) return 'Excellent!';
            else if(score >80) return 'Great!';
            else if(score >60) return 'So so';
            else if(score >50) return 'Not bad';
            else return 'Try harder';
        }
        
        function retrieveWords() {
            jQuery.ajax({
                    method: "GET",
                    url: "https://www.tistory.com/apis/comment/list",
                    data: {
                        access_token: "c80122b26dd7c701a5e4795e8d7ce444_02e5990259cbd49a6a406602a4903714",
                        blogName: "5789",
                        postId: "18",
                        output: 'json'
                    }
                })
                .done(function(msg) {
                    let comments = msg.tistory.item.comments;
                    let lines;
                    for(let i = comments.length-1; i>=0; i--){
                        if(comments[i].parentId===''){
                            lines = comments[i].comment.split('\n');
                            quizId = comments[i].id;
                            break;
                        }
                    }
                    for(let i = 0; i<lines.length; i++){
                        if(lines[i].startsWith('w:')){
                            let line = lines[i].substr(2);
                            if(""===line.trim()) continue;
                            let wordvals = line.split('@next@');
                            for(let j = 0; j<wordvals.length; j++){
                                let spWordvals = wordvals[j].split(',');
                                spWordvals[0] = spWordvals[0].trim();
                                spWordvals[1] = spWordvals[1].trim();
                                words[j] = spWordvals;
                            }
                        }else if(lines[i].startsWith('s:')){
                            let line = lines[i].substr(2);
                            if(""===line.trim()) continue;
                            sentences = line.split('@next@');
                        }
                    }
                    afterLoad();
                });
        }

        function sendResult(evalResult) {
            jQuery.ajax({
                    method: "POST",
                    url: "https://www.tistory.com/apis/comment/write",
                    data: {
                        access_token: "c80122b26dd7c701a5e4795e8d7ce444_02e5990259cbd49a6a406602a4903714",
                        blogName: "5789",
                        postId: "18",
                        parentId: quizId,
                        content: evalResult,
                        output: 'json'
                    }
                })
                .done(function(msg) {
                    console.log(msg);
                });
        }
        
        let newQuiz = {
            'register' : function (){
                let popupForm = document.querySelector('#registerQuizForm');
                let qfWords = popupForm.querySelectorAll('.qf-word');
                let qfSentences = popupForm.querySelectorAll('.qf-sentence');
                let wResult = "";
                let sResult = "";
                for(let i = 0; i<qfWords.length; i++){
                    let inputs = qfWords[i].querySelectorAll('input');
                    let source = inputs[0].value;
                    let target = inputs[1].value;
                    if(source!==""&&target!=="")
                        wResult = wResult + "@next@"+source + "," + target;
                }
                wResult = "w:"+wResult.substring(6);
                
                for(let i = 0; i<qfSentences.length; i++){
                    let input = qfSentences[i].querySelector('input');
                    if(input.value!=="")
                        sResult = sResult + "@next@"+input.value;
                }
                sResult = "s:"+sResult.substring(6);

                jQuery.ajax({
                    method: "POST",
                    url: "https://www.tistory.com/apis/comment/write",
                    data: {
                        access_token: "c80122b26dd7c701a5e4795e8d7ce444_02e5990259cbd49a6a406602a4903714",
                        blogName: "5789",
                        postId: "18",
                        content: wResult+"\n"+sResult,
                        output: 'json'
                    }
                })
                .done(function(msg) {
                    console.log(msg);
                    window.location.reload();
                });

            },
            'onKeyPressFirst' : function(){
               if(event.keyCode === 13){
                   let target = event.currentTarget; 
                   target.nextElementSibling.focus();
               }
            },
            'onKeyPressSecond' : function(){
                if(event.keyCode === 13){
                   let target = event.currentTarget; 
                   let p = document.createElement('p');
                   p.classList.add('qf-word');
                   p.innerHTML = '<input class="w3-input w3-padding-16 w3-border" type="text" style="width: 45%; display: inline"  placeholder="영어">\n<input class="w3-input w3-padding-16 w3-border" type="text" style="width: 45%; display: inline" placeholder="한국어">';
                   target.parentElement.parentElement.insertBefore(p,target.parentElement);
                   let oldInputs = target.parentElement.querySelectorAll('input');
                   let newInputs = p.querySelectorAll('input');
                   newInputs[0].value = oldInputs[0].value; 
                   newInputs[1].value = oldInputs[1].value;
                   oldInputs[0].value = "";
                   oldInputs[1].value = "";
                   oldInputs[0].focus();
                   let popupForm = document.querySelector('#registerQuizForm');
                   popupForm.scrollTop = popupForm.scrollHeight;
               }
            },
            'onKeyPressSentence' : function(){
                if(event.keyCode === 13){
                   let target = event.currentTarget; 
                   let p = document.createElement('p');
                   p.classList.add('qf-sentence');
                   p.innerHTML = '<input class="w3-input w3-padding-16 w3-border" type="text" placeholder="한국어 문장" onkeypress="newQuiz.onKeyPressSentence()">';
                   target.parentElement.parentElement.insertBefore(p,target.parentElement);
                   let oldInput = target.parentElement.querySelector('input');
                   let newInput = p.querySelector('input');
                   newInput.value = oldInput.value; 
                   oldInput.value = "";
                   oldInput.focus();
                   let popupForm = document.querySelector('#registerQuizForm');
                   popupForm.scrollTop = popupForm.scrollHeight;
               }
            }
        }
        
    </script>

</body>
</html>